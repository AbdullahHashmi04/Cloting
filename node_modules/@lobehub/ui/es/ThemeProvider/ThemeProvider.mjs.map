{"version":3,"file":"ThemeProvider.mjs","names":["ThemeProvider","currentClasses: string[]","newClasses: string[]","el: HTMLElement | null","el","lobeCustomStylish","theme","lobeCustomToken","FontLoader","AntdThemeProvider","AntdConfigProvider","GlobalStyle"],"sources":["../../src/ThemeProvider/ThemeProvider.tsx"],"sourcesContent":["'use client';\n\nimport { App } from 'antd';\nimport {\n  type CustomStylishParams,\n  type CustomTokenParams,\n  type GetAntdTheme,\n  ThemeProvider as AntdThemeProvider,\n} from 'antd-style';\nimport { merge } from 'es-toolkit/compat';\nimport { memo, useCallback, useLayoutEffect, useMemo, useRef } from 'react';\n\nimport { useCdnFn } from '@/ConfigProvider';\nimport FontLoader from '@/FontLoader';\nimport { lobeCustomStylish, lobeCustomToken } from '@/styles';\nimport { createLobeAntdTheme } from '@/styles/theme/antdTheme';\nimport { type LobeCustomToken } from '@/types/customToken';\n\nimport AntdConfigProvider from './ConfigProvider';\nimport { LOBE_THEME_APP_ID } from './constants';\nimport GlobalStyle from './GlobalStyle';\nimport { type ThemeProviderProps } from './type';\n\nconst CSS_VAR_PREFIX = 'css-var-';\n\nconst ThemeProvider = memo<ThemeProviderProps>(\n  ({\n    children,\n    customStylish,\n    customToken,\n    enableCustomFonts = true,\n    enableGlobalStyle = true,\n    customFonts,\n    customTheme = {},\n    className,\n    style,\n    theme: antdTheme,\n    ...rest\n  }) => {\n    const genCdnUrl = useCdnFn();\n    const appRef = useRef<HTMLDivElement>(null);\n\n    useLayoutEffect(() => {\n      const node = appRef.current;\n      if (!node) return;\n\n      const htmlEl = document.documentElement;\n      let currentClasses: string[] = [];\n\n      const syncCssVarClasses = () => {\n        for (const cls of currentClasses) {\n          htmlEl.classList.remove(cls);\n        }\n\n        const newClasses: string[] = [];\n        let el: HTMLElement | null = node;\n        while (el && el !== htmlEl) {\n          for (const cls of el.classList) {\n            if (cls.startsWith(CSS_VAR_PREFIX)) {\n              newClasses.push(cls);\n            }\n          }\n          el = el.parentElement;\n        }\n\n        for (const cls of newClasses) {\n          htmlEl.classList.add(cls);\n        }\n        currentClasses = newClasses;\n      };\n\n      syncCssVarClasses();\n\n      const observer = new MutationObserver(syncCssVarClasses);\n      let el: HTMLElement | null = node;\n      while (el && el !== htmlEl) {\n        observer.observe(el, { attributeFilter: ['class'] });\n        el = el.parentElement;\n      }\n\n      return () => {\n        observer.disconnect();\n        for (const cls of currentClasses) {\n          htmlEl.classList.remove(cls);\n        }\n      };\n    }, []);\n\n    const webfontUrls = useMemo(\n      () =>\n        customFonts || [\n          genCdnUrl({ path: 'css/index.css', pkg: '@lobehub/webfont-mono' }),\n          genCdnUrl({\n            path: 'css/index.css',\n            pkg: '@lobehub/webfont-harmony-sans',\n          }),\n          genCdnUrl({\n            path: 'css/index.css',\n            pkg: '@lobehub/webfont-harmony-sans-sc',\n          }),\n          genCdnUrl({ path: 'dist/katex.min.css', pkg: 'katex' }),\n        ],\n      [customFonts, genCdnUrl],\n    );\n\n    const stylish = useCallback(\n      (theme: CustomStylishParams) => ({ ...lobeCustomStylish(theme), ...customStylish?.(theme) }),\n      [customStylish],\n    );\n\n    const token = useCallback(\n      (theme: CustomTokenParams) => ({ ...lobeCustomToken(theme), ...customToken?.(theme) }),\n      [customToken],\n    );\n\n    const theme = useCallback<GetAntdTheme>(\n      (appearance) => {\n        const lobeTheme = createLobeAntdTheme({\n          appearance,\n          neutralColor: customTheme.neutralColor,\n          primaryColor: customTheme.primaryColor,\n        });\n        return merge(lobeTheme, antdTheme);\n      },\n      [customTheme.primaryColor, customTheme.neutralColor, antdTheme],\n    );\n\n    return (\n      <>\n        {enableCustomFonts &&\n          webfontUrls?.length > 0 &&\n          webfontUrls.map((webfont) => <FontLoader key={webfont} url={webfont} />)}\n        <AntdThemeProvider<LobeCustomToken>\n          customStylish={stylish}\n          customToken={token}\n          theme={theme}\n          {...rest}\n        >\n          <AntdConfigProvider>\n            {enableGlobalStyle && <GlobalStyle />}\n\n            <App\n              className={className}\n              style={{ isolation: 'isolate', minHeight: 'inherit', width: 'inherit', ...style }}\n            >\n              <div id={LOBE_THEME_APP_ID} ref={appRef} style={{ display: 'contents' }}>\n                {children}\n              </div>\n            </App>\n          </AntdConfigProvider>\n        </AntdThemeProvider>\n      </>\n    );\n  },\n);\n\nThemeProvider.displayName = 'LobeThemeProvider';\n\nexport default ThemeProvider;\n"],"mappings":";;;;;;;;;;;;;;;;;AAuBA,MAAM,iBAAiB;AAEvB,MAAMA,kBAAgB,MACnB,EACC,UACA,eACA,aACA,oBAAoB,MACpB,oBAAoB,MACpB,aACA,cAAc,EAAE,EAChB,WACA,OACA,OAAO,WACP,GAAG,WACC;CACJ,MAAM,YAAY,UAAU;CAC5B,MAAM,SAAS,OAAuB,KAAK;AAE3C,uBAAsB;EACpB,MAAM,OAAO,OAAO;AACpB,MAAI,CAAC,KAAM;EAEX,MAAM,SAAS,SAAS;EACxB,IAAIC,iBAA2B,EAAE;EAEjC,MAAM,0BAA0B;AAC9B,QAAK,MAAM,OAAO,eAChB,QAAO,UAAU,OAAO,IAAI;GAG9B,MAAMC,aAAuB,EAAE;GAC/B,IAAIC,OAAyB;AAC7B,UAAOC,QAAMA,SAAO,QAAQ;AAC1B,SAAK,MAAM,OAAOA,KAAG,UACnB,KAAI,IAAI,WAAW,eAAe,CAChC,YAAW,KAAK,IAAI;AAGxB,WAAKA,KAAG;;AAGV,QAAK,MAAM,OAAO,WAChB,QAAO,UAAU,IAAI,IAAI;AAE3B,oBAAiB;;AAGnB,qBAAmB;EAEnB,MAAM,WAAW,IAAI,iBAAiB,kBAAkB;EACxD,IAAID,KAAyB;AAC7B,SAAO,MAAM,OAAO,QAAQ;AAC1B,YAAS,QAAQ,IAAI,EAAE,iBAAiB,CAAC,QAAQ,EAAE,CAAC;AACpD,QAAK,GAAG;;AAGV,eAAa;AACX,YAAS,YAAY;AACrB,QAAK,MAAM,OAAO,eAChB,QAAO,UAAU,OAAO,IAAI;;IAG/B,EAAE,CAAC;CAEN,MAAM,cAAc,cAEhB,eAAe;EACb,UAAU;GAAE,MAAM;GAAiB,KAAK;GAAyB,CAAC;EAClE,UAAU;GACR,MAAM;GACN,KAAK;GACN,CAAC;EACF,UAAU;GACR,MAAM;GACN,KAAK;GACN,CAAC;EACF,UAAU;GAAE,MAAM;GAAsB,KAAK;GAAS,CAAC;EACxD,EACH,CAAC,aAAa,UAAU,CACzB;CAED,MAAM,UAAU,aACb,aAAgC;EAAE,GAAGE,sBAAkBC,QAAM;EAAE,GAAG,gBAAgBA,QAAM;EAAE,GAC3F,CAAC,cAAc,CAChB;CAED,MAAM,QAAQ,aACX,aAA8B;EAAE,GAAGC,oBAAgBD,QAAM;EAAE,GAAG,cAAcA,QAAM;EAAE,GACrF,CAAC,YAAY,CACd;CAED,MAAM,QAAQ,aACX,eAAe;AAMd,SAAO,MALW,oBAAoB;GACpC;GACA,cAAc,YAAY;GAC1B,cAAc,YAAY;GAC3B,CAAC,EACsB,UAAU;IAEpC;EAAC,YAAY;EAAc,YAAY;EAAc;EAAU,CAChE;AAED,QACE,8CACG,qBACC,aAAa,SAAS,KACtB,YAAY,KAAK,YAAY,oBAACE,sBAAyB,KAAK,WAAd,QAAyB,CAAC,EAC1E,oBAACC;EACC,eAAe;EACf,aAAa;EACN;EACP,GAAI;YAEJ,qBAACC,qCACE,qBAAqB,oBAACC,wBAAc,EAErC,oBAAC;GACY;GACX,OAAO;IAAE,WAAW;IAAW,WAAW;IAAW,OAAO;IAAW,GAAG;IAAO;aAEjF,oBAAC;IAAI,IAAI;IAAmB,KAAK;IAAQ,OAAO,EAAE,SAAS,YAAY;IACpE;KACG;IACF,IACa;GACH,IACnB;EAGR;AAED,gBAAc,cAAc;AAE5B,4BAAeX"}